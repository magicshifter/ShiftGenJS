
<!DOCTYPE html>
<html lang="en">
<head>
    <title>MagicShifter WebGL Demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            color: #000;
            font-family:Monospace;
            font-size:13px;
            text-align:center;
            font-weight: bold;

            background-color: #fff;
            margin: 0px;
            overflow: hidden;
        }

        #info {
            color:#000;
            position: absolute;
            top: 0px; width: 100%;
            padding: 5px;

        }

        a {
            color: red;
        }
    </style>
</head>

<body>
<div id="container"></div>
<div id="info">
    <a href="http://threejs.org" target="_blank">three.js</a> - orbit controls example
</div>

<script src="libs/three.js"></script>

<script src="libs/three/OrbitControls.js"></script>

<script src="libs/three/Detector.js"></script>
<script src="libs/three/STLLoader.js"></script>
<script src="libs/stats.min.js"></script>

<script>

    var simState = {
        steps: 50,
        startStep: 0,
        ledRadius: 2,

        axisX: 0.1,
        axisY: 0.9,
        axisZ: 0.11,

        startX: -100,
        startY: 0,
        startZ: 200,

        shifterDirX: 0,
        shifterDirY: 10,
        shifterDirZ: 0,

        transX: 0,
        transY: 0,
        transZ: 0,

        rotSpeed: 0.035,
    };

    var axis = new THREE.Vector3(simState.axisX, simState.axisY, simState.axisZ);
    axis.normalize();
    var m = new THREE.Matrix4();
    m.makeRotationAxis(axis, simState.rotSpeed);
    var t = new THREE.Matrix4();
    t.makeTranslation(simState.transX, simState.transY, simState.transZ);
    m.multiply(t);

    var requestAnimFrame = (function(){
        return  window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                function(callback, element){ setTimeout(callback, 1000 / 60); };
    })();

    // if ms == 0 use AbimationLoop otherwise fixed timing
    var AnimationLoop = function(ms, callback) {
        this.ms = ms;
        this.callback = callback;
        this.pauseRequested = true;
    };

    AnimationLoop.prototype.start = function() {
        var loopContext = this;
        this.pauseRequested = false;
        var myFn = function() {
            // requestnext frame aspa according to: https://developer.mozilla.org/en-US/docs/Games/Anatomy
            if (!loopContext.pauseRequested) {
                if (loopContext.ms)
                    setTimeout(myFn, loopContext.ms);
                else
                    requestAnimFrame(myFn);

                loopContext.callback();
            }
        };
        myFn();
    };

    AnimationLoop.prototype.step = function() {
        this.callback();
    }

    AnimationLoop.prototype.stop = function() {
        this.pauseRequested = true;
    }

    AnimationLoop.prototype.toggle = function() {
        if (this.pauseRequested) {
            this.start();
        }
        else {
            this.stop();
        }
    }

    if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

    var container, stats;

    var camera, controls, scene, renderer;
    var group = new THREE.Object3D();
    var group2 = new THREE.Object3D();

    init();
    render();

    function animate() {

        requestAnimationFrame(animate);
        controls.update();

    }

    function init() {

        camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
        camera.position.z = 200;
        camera.position.y = 50;

        controls = new THREE.OrbitControls( camera );
        controls.damping = 0.2;
        controls.addEventListener( 'change', render );

        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2( 0xcccccc, 0.002 );

        // world

        var geometry = new THREE.CylinderGeometry( 0, 10, 30, 4, 1 );
        var material =  new THREE.MeshLambertMaterial( { color:0xffffff, shading: THREE.FlatShading } );

        for ( var i = 0; i < 0; i ++ ) {

            var mesh = new THREE.Mesh( geometry, material );
            mesh.position.x = ( Math.random() - 0.5 ) * 1000;
            mesh.position.y = ( Math.random() - 0.5 ) * 1000;
            mesh.position.z = ( Math.random() - 0.5 ) * 1000;
            mesh.updateMatrix();
            mesh.matrixAutoUpdate = false;
            scene.add( mesh );

        }

        var loader = new THREE.STLLoader();
        loader.load("stl/magicshifter_case_104_top.stl", function (geometry) {
            console.log(geometry);
            var mat = new THREE.MeshLambertMaterial({color: 0x4444FF});
            group2 = new THREE.Mesh(geometry, mat);
            group2.rotateX(Math.PI);
            //group2.rotation.x = -0.5 * Math.PI;
            //group2.scale.set(0.6, 0.6, 0.6);
            scene.add(group2);
            render();
        });

        var loader = new THREE.STLLoader();
        loader.load("stl/magicshifter_case_104_bottom.stl", function (geometry) {
            console.log(geometry);
            var mat = new THREE.MeshLambertMaterial({color: 0xFF4444});
            group = new THREE.Mesh(geometry, mat);
            group.rotateX(Math.PI)
            //group.rotation.x = -0.5 * Math.PI;
            //group.scale.set(0.6, 0.6, 0.6);
            scene.add(group);
            render();
        });




        // lights

        light = new THREE.DirectionalLight( 0xffffff );
        light.position.set( 1, 1, 1 );
        scene.add( light );

        light = new THREE.DirectionalLight( 0xffffff );
        light.position.set( -1, -1, -1 );
        scene.add( light );

        light = new THREE.AmbientLight( 0x333333 );
        scene.add( light );


        // renderer

        renderer = new THREE.WebGLRenderer( { antialias: false } );
        renderer.setClearColor( scene.fog.color, 1 );
        renderer.setSize( window.innerWidth, window.innerHeight );

        container = document.getElementById( 'container' );
        container.appendChild( renderer.domElement );

        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        stats.domElement.style.zIndex = 100;
        container.appendChild( stats.domElement );

        //

        window.addEventListener( 'resize', onWindowResize, false );

        controls.addEventListener('change', render);
        animate();

    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );

        render();

    }

    function render() {

        renderer.render( scene, camera );
        stats.update();

    }

    window.addEventListener( 'keydown', onKeyDown, false );

    function onKeyDown( event ) {
        switch ( event.keyCode ) {

            case 42:
               alert("sp")
                break;

            case 27:
                var l = new AnimationLoop(1000/60, function() {
                    group.applyMatrix(m);
                    render();
                });
                l.start();
                break;

        }
    }

</script>

</body>
</html>
